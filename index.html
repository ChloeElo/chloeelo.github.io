<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<head>
<style>

@font-face {
    font-family: WildWords;
    src: url(wildwords.ttf);
}

body {
	position:absolute;
	background-color: black;
	justify-content: center;
	margin: 0;
	overflow:auto;
	-ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
    text-align: center;
	touch-action: pan-y;
}

body::-webkit-scrollbar { 
    display: none;  /* Safari and Chrome */
}

#contentbox {
	position: absolute;
	width: 100vw;
	padding-top: 75px;
}

#searchbox {
	position: fixed;
	justify-content: center;
    align-items: center;
	text-align: center;
	margin: 0,auto;
	height: 75px;
	width: 100vw;
	display:flex;
}

#searchbar {
	justify-content: center;
    align-items: center;
	text-align: center;
	margin: auto;
	background-color: #4a4c51;
	width:90%;
	height:fit-content;
	min-height:24px;
	color: #C0C0C0;
	font-size: 16pt;
	font-family: sans-serif;
	border-radius: 20px;
	opacity: 0.7;
	padding-top:5px;
	padding-bottom:5px;
	padding-left: 10px;
	padding-right: 10px;
}

#searchbar:hover {
	opacity:1;
	transition:200ms;
}

.grouptitle {
	color: white;
	font-family: sans-serif;
	color: #4a4c51;
	font-size: 24pt;
	margin: 0;
}

.grid-container {
	display: grid;
	grid-gap: 5px;
	width: 100vw;
	justify-content: center;
    align-items: center;
    overflow: hidden;
	padding-top: 5px;
	padding-bottom: 5px;
}

.image {
	width: 100%;
	object-fit: cover;
	aspect-ratio: 1;
	border-radius: 10px;
}

.line {
	width: 100%;
	object-fit: contain;
	aspect-ratio: 1;
	border-radius: 10px;
	outline: black solid 1px;
}

.gray {
	filter: grayscale(100%) brightness(50%);
}

.nodrag {
	user-drag: none;
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
}

.image:hover {
	outline: white solid 4px;
	transition:100ms;
}

.hidden {
	transition: opacity 0.75s ease-out !important;
    opacity: 0 !important;
    height: 0;
    overflow: hidden !important;
	pointer-events: none;
}

#tagbox {
	position:fixed;
	top:65px;
	width:100vw;
	height:100vh;
	overflow:hidden;
	transition: opacity 0.5s ease-in;
}

#sunglasses {
	position:fixed;
	background-color: black;
	opacity:0.8;
	transition: opacity 0.5s ease-in;
	width:100vw;
	height:100vh;
}

#taglist {
	width:100%;
	height:fit-content;
	max-height:calc(100vh - 90px);
	display: inline-flex;
	flex-flow: wrap;
	justify-content: center;
	overflow-y:auto;
}

#searchoptions {
	width:100%;
	height:30px;
	margin-bottom:5px;
}

#jumpto {
	font-size: 12pt;
	font-family: sans-serif;
	width:150px;
	height:24px;
	border-radius:10px;
	text-align: center;
	margin-top:0px;
	margin-left:10px;
	padding:1px;
	border-width:2px;
}

#sort {
	font-size: 14pt;
	font-family: sans-serif;
	width:150px;
	height:26px;
	border-radius:10px;
	text-align: center;
	margin-top:0px;
	padding:1px;
	border-width:1px;
}

#sort:hover {
	color: gray;
	transition:200ms;
}

#suggestsearch {
	font-size: 14pt;
	font-family: sans-serif;
	width:180px;
	height:26px;
	border-radius:10px;
	text-align: center;
	margin-top:0px;
	margin-left:10px;
	padding:1px;
	border-width:1px;
	border-style: groove;
}

#suggestsearch:hover {
	color: gray;
	transition:200ms;
}

#imgtaglist {
	width:100%;
	height:fit-content;
	display: inline-flex;
	flex-flow: wrap;
	justify-content: center;
	overflow-y:auto;
}

.tag_bubble {
	background-color: #808080;
	color: white;
	font-family: sans-serif;
	font-size: 14pt;
	padding-left:10px;
	padding-right:10px;
	padding-top:3px;
	padding-bottom:3px;
	margin-left:5px;
	margin-right:5px;
	margin-top:3px;
	margin-bottom:3px;
	border-radius: 10px;
	height:fit-content;
	opacity:0.9;
	white-space: nowrap;
}

.tag_bubble:hover {
	background-color: #A0A0A0;
	transition:100ms;
}

#focusbox {
	background-color: black;
	position:fixed;
	height:100vh;
	width:100vw;
	opacity:1;
	transition: opacity 0.5s ease-in;
}

#backbutton {
	position:fixed;
	top:0px;
	left:0px;
	width: 75px;
	height: 75px;
	border-radius: 50%;
}

#colorbutton {
	position:fixed;
	top:0px;
	left:0px;
	width: 75px;
	height: 75px;
	border-radius: 50%;
	opacity:0.7;
}

#colorbutton:hover {
	opacity:1;
	transition:200ms;
}

.fullopacity {
	
}

.graybutton {
	filter: grayscale(1);
}

#focuslinks {
	position:fixed;
	bottom:0;
	left:50%;
	transform: translateX(-50%);
	width:100vw;
	max-width:600px;
	height:fit-content;
	display: flex;
	justify-content: space-between;
}

.focusbar {
	display: inline-block;
	width:20vw;
	max-width:100px;
	aspect-ratio:1;
}

#scoring {
	width:fit-content;
	max-width:100vw;
	height:fit-content;
	display: flex;
	justify-content: space-between;
	margin: auto;
}

.scorebar {
	max-width:300px;
	width:50vw;
	background-color: #303030;
	color: white;
	font-family: sans-serif;
	font-size: 24pt;
	padding-left:10px;
	padding-right:10px;
	padding-top:3px;
	padding-bottom:3px;
	margin-left:5px;
	margin-right:5px;
	margin-top:5px;
	margin-bottom:3px;
	border-radius: 10px;
	height:fit-content;
}

.scorebar:hover {
	background-color: #505050;
	transition:100ms;
}

.liked {
	background-color: #477a17 !important;
}

.favorited {
	background-color: #9d1c15 !important;
}

.fade:hover {
	opacity:0;
	transition:200ms;
}

#x_button {
	background-color:black;
	color:#A0A0A0;
	position:fixed;
	right:5%;
	top:25px;
	border-radius: 50%;
	aspect-ratio:1;
}

#x_button:hover {
	background-color: #8B0000;
	transition:200ms;
}
}

</style>
<link rel="icon" type="image/x-icon" href="Assets/favicon.ico" />
<!-- <script src="./index.js" defer></script> -->
<title>ChloeBooru</title>

</head>

<body>
	<div id="contentbox"></div>
	<div id='sunglasses' class="hidden"> </div>
	<div id='searchbox'>
		<input id="searchbar" type="text" spellcheck="false" placeholder="Search..." class="nodrag" onclick="showTags()" onkeyup="updateSearchbar()">
	</div>
	<div id='tagbox' class="hidden">
		<div id='searchoptions'>
			<select id='sort' onchange='if(document.getElementById("sort").value=="rand") { shuffle(); } redrawImages();'>
				<option value="new">Sort Newest</option>
				<option value="old">Sort Oldest</option>
				<option value="rand">Sort Random</option>
			</select>
			<button id='suggestsearch' onclick='suggestSearch()'> Explore Searches </button>
			<input type="number" id="jumpto" min="1" max="999" placeholder="Jump to number..." onkeypress="jumpTo(event)" style="display:none;">
		</div>
		<div id='taglist' class="flex-container"></div>
		<div id='taglist_below' onclick="hideTags()" style="width:100%;height:100vh;"></div>
	</div>
	<button id='x_button' onclick='xclicked()'> <b>X</b> </button>
	<img id="colorbutton" onclick="switchMode()" src='Assets/b_color.png'>
	<img id="backbutton" onclick="switchMode()" style="display:none;" src='Assets/b_back.png'>
	<div id="focusbox" class="hidden nodrag">
		<div id='focusback'  style="height:fit-content;width:100vw;">
			<img id='focusimg' onclick="hideFocus()" style="max-height:70vh;width:100%;max-width:100%;object-fit:contain;image-rendering:pixelated;display:block;" class='nodrag'>
			<video id='focusvid' onclick="hideFocus()" style="max-height:70vh;width:100%;max-width:100%;display:none;" playsinline loop>
				<source src="" type="video/mp4" />
			</video>
		</div>
		<div id='scoring'>
			<h5 id='like' class='scorebar nodrag' onclick="score('like')"> Like </h5>
			<h5 id='favorite' class='scorebar nodrag' onclick="score('favorite')"> Favorite </h5>
		</div>
		<div id='imgtaglist' class="flex-container nodrag"></div>
		<div id='imgtaglist_below' class='nodrag' onclick="hideFocus()" style="width:100%;height:100vh;overflow:hidden;"></div>
		<div id='focuslinks' class='nodrag'>
			<div id='twitterdiv' style='text-align:center;position:relative;display:block;'>
				<img id='twitter' class="focusbar nodrag fade" style="position:absolute;" src='Assets/b_twitter.png'>
				<img id='twitter2' class="focusbar nodrag" src='Assets/b_twitter2.png'>
			</div> 
			<div id='redditdiv' style='text-align:center;position:relative;'>
				<img id='reddit' class="focusbar nodrag fade" style="position:absolute;" src='Assets/b_reddit.png'>
				<img id='reddit2' class="focusbar nodrag" src='Assets/b_reddit2.png'>
			</div> 
			<div id='discorddiv' style='text-align:center;position:relative;'>
				<img id='discord' class="focusbar nodrag fade" style="position:absolute;" src='Assets/b_discord.png'>
				<img id='discord2' class="focusbar nodrag" src='Assets/b_discord2.png'>
			</div> 
			<div id='hoodiediv' style='text-align:center;position:relative;display:none;'>
				<img id='hoodie' class="focusbar nodrag fade" style="position:absolute;" src='Assets/b_hoodie.png'>
				<img id='hoodie2' class="focusbar nodrag" src='Assets/b_hoodie2.png'>
			</div> 
			<div id='heartsdiv' style='text-align:center;position:relative;'>
				<img id='hearts' class="focusbar nodrag fade" style="position:absolute;" src='Assets/b_gumroad.png'>
				<img id='hearts2' class="focusbar nodrag" src='Assets/b_gumroad2.png'>
			</div> 
		</div>
	</div>
	
	

</body>

<script src="data.js"></script>

<script>
	
	var search_string = '';
	var counts = {};
	var include
	var exclude
	var hearts = 0;
	var valid_images = []
	
	urlParams = new URLSearchParams(window.location.search);
	paramselection = urlParams.get('search'); // Parameter for default search
	// if (paramselection) { modifySelection(paramselection.replace("%20"," "),'set'); }
	// else { downselect(); redrawImages(); }
	
	url_nnn = urlParams.get('nnn'); // Parameter to jump to image num
	if (url_nnn) {
		hearts=1;
	}
	
	var tag_sets = {}
	function generateSets() {
		tag_sets['all'] = []; // Master set of all grafs
		for (let i=0; i < search_tags.length; i++) { tag_sets[search_tags[i]] = []; }
		for (let [name, graf] of graf_data) {
			tag_sets['all'].push(name)
			graf.tags.forEach((tag) => {
				if (!(tag in tag_sets)) { tag_sets[tag] = []; } // If tag not initialized in search_tags, initialize our own
				tag_sets[tag].push(name)
				}
			);
		}
	}
	
	generateSets()
	
	var suggest_number = 0;
	var searchSuggestions = [
		"sketch ",
		"cat_ears +cat_outfit ",
		"head_focus ",
		"all gura +ina +hololive ",
		"ribbon_outfit ",	
		"animated ",
		"pasties ",
		"dino ",
		"angry +annoyed +neutral_face +scared +surprised ",
		"brown_skin ",
		"bunny_suit ",
		"all amber +albino_girl +claire +colette +iris +lila_violette +star_girl +willow +zoe ",
		//"plotlo ",
		"@dobbele ",
		"sketches ",
		"genshin_impact +blue_archive ",
		"horror +blood ",
		"claw +horns +wings ",
		"hoodie -tank_top -bikini ",
		"manga_style ",
		]
	function suggestSearch() {
		
		//i = Math.floor(Math.random()*searchSuggestions.length);
		
		document.getElementById('searchbar').value= searchSuggestions[suggest_number%searchSuggestions.length];
		updateSearchbar();
		hideTags();
		suggest_number = suggest_number +1;

	}
	
	function intersection(a,b) { return a.filter(x => b.includes(x)); } // These should really be native...
	function difference(a,b) { return a.filter(x => !b.includes(x)); }
	function union(a,b) { return [...new Set([...a,...b])]; }
	
	function updateCounts() {
		valid_images = []
		valid_set = tag_sets['all']
		let tags_searched = []
		
		if (search_string!="") {
			let selection_list = search_string.split(" ");
			for (let i=0; i < selection_list.length; i++){
				
				if (selection_list[i][0]=="-"||selection_list[i][0]=="+") { tag = selection_list[i].substr(1); }
				else { tag = selection_list[i]; }
				
				if (!Object.hasOwn(tag_sets,tag)) { valid_set = []; continue }
				
				tags_searched.push(tag);
				
				if (selection_list[i][0]=="-") { valid_set = difference(valid_set,tag_sets[tag]); }
				else if (selection_list[i][0]=="+") { valid_set = union(valid_set,tag_sets[tag]); }
				else { valid_set = intersection(valid_set,tag_sets[tag]); }
			}
		}
		
		counts = {} // Tagcounts are shown next to tag names
		for (let i=0; i < search_tags.length; i++){ counts[search_tags[i]] = 0 } // Reset all to 0 before we start counting
		
		for (let i=0; i < valid_set.length; i++){
			let name = valid_set[i];
			let graf = graf_data.get(name);
			if (hearts && !(graf.heart||graf.nnn) ) { continue }
			if (hearts==0 && search_string=="" && !Number.isInteger(Number(name))) { continue } // Show only integers if no search
			if (hearts==0 && graf.req) { // This graf requires a tag in the search string to be shown
				if (!search_string.includes('all')&&!search_string.includes(graf.req)) { continue }
			}
			let tags = graf.tags;
			valid_images.push(name);
			for (let i=0; i < tags.length; i++){
				if (tags_searched.includes(tags[i])) { continue }
				counts[tags[i]] += 1;
			}
		}
	}
	
	function updateCounts2() {
		include = []
		exclude = []
		valid_images = []
		
		if (search_string!="") {
			let selection_list = search_string.split(" ");
			for (let i=0; i < selection_list.length; i++){
				if (selection_list[i][0]=="-") { exclude.push(selection_list[i].substr(1)) }
				else { include.push(selection_list[i]) }
			}
		}
		
		counts = {} // Tagcounts are shown next to tag names
		for (let i=0; i < search_tags.length; i++){ counts[search_tags[i]] = 0 } // Reset all to 0 before we start counting
		
		for (const [name,graf] of graf_data) {
			if (hearts && !(graf.heart||graf.nnn) ) { continue }
			if (hearts==0 && search_string=="" && !Number.isInteger(Number(name))) { continue } 
			if (hearts==0 && graf.req) { // This graf requires a tag in the search string to be shown
				if (!search_string.includes(graf.req)) { continue }
			}
			let tags = graf.tags;
			if ( contains(include,tags) && excludes(exclude,tags) ) { // Check that valid images have tags matching searchbar filter
				valid_images.push(name);
				for (let i=0; i < tags.length; i++){
					if ( !include.includes(tags[i]) && !exclude.includes(tags[i]) ) { // Don't actually count the tags in the searchbar tho
						counts[tags[i]] += 1;
					}
				}
			}
		}
		//console.log(valid_images);
	}
	
	function xclicked() {
		if (document.getElementById("searchbar").value=='') {
			hideTags()
		}
		else {
			document.getElementById("searchbar").value="";
			updateSearchbar();
		}
	}
	
	function finishSearchTag(tag) {
		if ( tag.includes(" ") ) { tag = tag.substr(0,tag.indexOf(" ")); } // Get rid of num after the space
		let searchbar = document.getElementById("searchbar");
		lastspace = searchbar.value.lastIndexOf(' ');
		lastminus = searchbar.value.lastIndexOf('-');
		lastplus = searchbar.value.lastIndexOf('+');
		if (lastminus>lastspace) { index=lastminus; }
		else if (lastplus>lastspace) { index=lastplus; }
		else { index=lastspace; }
		if (index==-1) { // Neither space nor minus is present
			searchbar.value = tag + ' '; // Set whole string to tag
		}
		else {
			searchbar.value = searchbar.value.slice(0,index+1) + tag + ' ';
		}
		updateSearchbar()
	}

	function contains(these,inthis){ if (these.length==0) { return 1 } else { return these.every(i => inthis.includes(i)); } } // Self explanatory
	function excludes(these,inthis){ if (these.length==0) { return 1 } else { return !these.some(i => inthis.includes(i)); } } // Self explanatory
	
	function updateTags(tags) {
		const taglist = document.getElementById("taglist");
		while (taglist.lastElementChild) { // Clear taglist
			taglist.removeChild(taglist.lastElementChild);
		}
		
		let searchbar = document.getElementById("searchbar");
		
		if (search_string!="") {
			let selection_list = search_string.split(" ");
			for (let i=0; i < selection_list.length; i++){
				if (selection_list[i][0]=="-") {
					tag = selection_list[i].substr(1);
					let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
					tag_bubble.style.backgroundColor = "red";
					tag_bubble.innerHTML = '-'+tag;
					tag_bubble.onclick = function() { searchbar.value = searchbar.value.replace(tag_bubble.innerHTML+' ',""); updateSearchbar(); };
					taglist.appendChild(tag_bubble)
				}
				else if (selection_list[i][0]=="+") {
					tag = selection_list[i].substr(1);
					let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
					tag_bubble.style.backgroundColor = "blue";
					tag_bubble.innerHTML = '+'+tag;
					tag_bubble.onclick = function() { searchbar.value = searchbar.value.replace(tag_bubble.innerHTML+' ',""); updateSearchbar(); };
					taglist.appendChild(tag_bubble)
				}
				else {
					tag = selection_list[i];
					let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
					tag_bubble.style.backgroundColor = "green";
					tag_bubble.innerHTML = tag;
					tag_bubble.onclick = function() { searchbar.value = searchbar.value.replace(tag_bubble.innerHTML+' ',""); updateSearchbar(); };
					taglist.appendChild(tag_bubble)
				}
			}
		}

		for (i=0; i<tags.length; i++) {
			let tag = tags[i];
			if (plusflag || counts[tag]>0) { // Grey bubbles for all the remaining tags that can still be applied
				let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
				if (plusflag) { tag_bubble.innerHTML = tag + " (" + tag_sets[tag].length + ")"; }
				else { tag_bubble.innerHTML = tag + " (" + String(counts[tag]) + ")"; }
				tag_bubble.onclick = function() { finishSearchTag(tag_bubble.innerHTML); };
				tag_bubble.style.fontSize = String(Math.floor(Math.sqrt(counts[tag])+10))+"px";
				//console.log( tag, Math.floor(Math.sqrt(counts[tag])+10) );
				taglist.appendChild(tag_bubble)
			}
		}
		
		if (isNumbers.test(last_tag)) {
			for (i=0; i<valid_images.length; i++) {
				if (String(valid_images[i]).includes(last_tag)){
					let num_bubble = mkElement("h3", "num_"+valid_images[i], "tag_bubble nodrag");
					num_bubble.innerHTML = valid_images[i];
					num_bubble.onclick = function() { jumpNum(num_bubble.innerHTML) };
					num_bubble.style.fontSize = "16px";
					taglist.appendChild(num_bubble)
				}
			}
		}
		
	}

	var isNumbers = /^\d+$/; // Regex that tests if a string is only numbers
	
	var last_tag = ''
	var plusflag = 0;
	function updateSearchbar() {
		let selection = document.getElementById("searchbar");
		
		if (event instanceof KeyboardEvent){
			if (event.key==='Enter') {
				selection.value = selection.value + ' '; //Terminal space to trigger search update
			}
		}
		
		selection.value = selection.value.toLowerCase();
		selection.value = selection.value.replace(/[^abcdefghijklmnopqrstuvwxyz0123456789_ +-@]/g, '');
		selection.value = selection.value.replace("  "," ");
		selection.value = selection.value.replace(" + "," +");
		selection.value = selection.value.replace(" - "," -");
		if (selection.value[0]==' ') { selection.value = selection.value.slice(1); }
		if (selection.value.slice(-1)=='-' && selection.value.slice(-2)!=' -') { selection.value = selection.value.slice(0,-1) + ' -'; }
		if (selection.value.slice(-1)=='+' && selection.value.slice(-2)!=' +') { selection.value = selection.value.slice(0,-1) + ' +'; }
		//if (selection.value[0]==' ') { selection.value = selection.value.slice(1); return }
		
		last_mtag = selection.value.split(' ').slice(-1)[0];
		if (last_mtag.includes('+')) { plusflag=1; } //Used to determine what count to show on potential tag bubbles
		else { plusflag=0; }
		last_tag = last_mtag.replace('+','').replace('-','');
		
		let search_set = selection.value.split(' ').slice(0,-1).join(' ');
		
		if (event instanceof KeyboardEvent){
			if (event.key==='Enter') {
				if (!isNaN(search_set.split(' ').slice(-1))) { // Some kind of number
					document.getElementById('jumpto').value=search_set.split(' ').slice(-1);
					search_set = search_set.split(' ').slice(0,-1).join(' ');
				}
				search_string = search_set;
				//console.log(search_string);
				updateCounts();
				redrawImages();
				hideTags();
				jumpTo('bypass');
				selection.blur();
				return
			}
		}
		
		
		if (search_string != search_set) {
			
			search_string = search_set;
			
			updateCounts();
			redrawImages();
		}
		
		potential_tags = search_tags.filter(tag => tag.includes(last_tag));
		updateTags(potential_tags);
	}
	
	var cookie = Object.fromEntries(document.cookie.split('; ').map(c => c.split('='))) // Turn cookie string into object with named properties
	
	function makeid(length) { // Generate a random alphanumeric ID out of 62 chars
		let result = "";
		const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for (var i = 0; i < length; i++) { result += charset.charAt(Math.floor(Math.random() * charset.length)); }
		return result;
	}
	
	function setCookie(id,value) { document.cookie = id + "=" + value + "; expires=Tue, 1 Jan 2030 12:00:00 UTC"; }
	
	if (!Object.hasOwn(cookie,'uuid')) {
		setCookie('uuid',makeid(5));
		setCookie('likes',"");
		setCookie('favorites',"");
		setCookie('logintime',0);
		cookie = Object.fromEntries(document.cookie.split('; ').map(c => c.split('=')))
	}
	
	if (cookie.likes) {	cookie.likes = cookie.likes.split(','); }
	else { cookie.likes = []; }
	if (cookie.favorites) {
		cookie.favorites = cookie.favorites.split(',');
		for(let i=0; i<cookie.favorites.length; i++) { graf_data.get(cookie.favorites[i]).tags.push('favorites') }
	}
	else { cookie.favorites = []; }
	
	console.log('Cookie:',cookie);
	
	updateCounts();
	updateSearchbar();
	redrawImages();
	
	var score_counts = 0;
	
	function sendscore(payload) {
		let xhr = new XMLHttpRequest();
		xhr.open(
			"GET",
			"https://script.google.com/macros/s/AKfycbzCW8CddIs6OLk9G4E2ZpFI60LhHNMX0_C2YIXfawvLRVMKfh70c1138vY1-9XMynAT/exec"+payload,
			true
		);
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.onreadystatechange = function () {
			// Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE) {
				//console.log(this);
				if (this.status === 200) {
					let response = JSON.parse(xhr.response)
					if (response != 'success') { score_counts = response; }
				}
				else {
					let response = JSON.parse("[" + xhr.response + "]")
					console.log("Send failed", this.status, response);
				}
			}
		};
		console.log(payload);
		xhr.send(); // -----> ENABLE BEFORE FLIGHT <-----
	}
	
	function sendsearch(payload) {
		let xhr = new XMLHttpRequest();
		xhr.open(
			"GET",
			"https://script.google.com/macros/s/AKfycbxeYobZDBSNr8soOSeCQjhpbbLRJyHsjT_ODBDNLrv8aiKOMKkPJujQIILFAVrmbrSTKA/exec"+payload,
			true
		);
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.onreadystatechange = function () {
			// Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE) {
				//console.log(this);
				if (this.status === 200) {
					let response = JSON.parse(xhr.response);
				}
				else {
					let response = JSON.parse("[" + xhr.response + "]")
					console.log("Send failed", this.status, response);
				}
			}
		};
		console.log(payload);
		xhr.send(); // -----> ENABLE BEFORE FLIGHT <-----
	}
	
	if (Date.now()-cookie.logintime>900000) { //15min in ms
		sendsearch("?u="+cookie.uuid+"&t=i&l="+navigator.languages+'&z='+Intl.DateTimeFormat().resolvedOptions().timeZone+'&a='+navigator.userAgent);
		setCookie('logintime',Date.now());
	}
	sendscore("?u="+cookie.uuid+"&t=r");
	
	//send('initialize');
	
	let width = window.innerWidth;
	const initialBlockWidths = [2,3,4,5,6,8,10,15,20]; 
	var blockWidths = initialBlockWidths; // Add 25, 34 and 50 to this if wide enough
	let blocklimit = Math.floor(width/25);
	if (blocklimit >= 25) { initialBlockWidths.push(25) };
	if (blocklimit >= 34) { initialBlockWidths.push(34) };
	if (blocklimit >= 50) { initialBlockWidths.push(50) };
	
	var blocks = Math.floor((width-100)/100); // Set ideal default block width based on screen res
	if (blocks < 1) { blocks = 1; }
	//if (blocks > 5) { blocks = 5; } // Cap block width to 5 on load to avoid lagginess when the browser has to load hundreds of images at once

	stylesheet = document.styleSheets[0]
	//stylesheet.insertRule(".grid-container { grid-template-columns: repeat("+String(blocks)+", minmax(0, 1fr));}", 0);
	
	grid_xscale = [0,0.15,0.3,0.45,0.6,0.75,0.85,0.95,1.1]; // 1.1 is there for initial block scaling reference - me much later, WTF does that mean?
	
	document.getElementById("discord").onclick= function() { window.open("https://discord.com/invite/TsBGYz4VTg"); }
	
	var minblocks = Math.ceil(window.innerWidth/400); // Don't force upscale of images past 400px - see below
	var mode = 'Images';
	
	window.addEventListener("resize", (event) => { // If the browser expands, expand minblocks - TODO make sure minblocks and maxblocks don't nonintersect
		console.log('resize');
		minblocks = Math.ceil(window.innerWidth/400); // N+1 minblock per 400px of width so images are never upscaled, only downscaled on the grid
		if (blocks < minblocks) {
			blocks = minblocks;
			reblockGrid()
		}
	});
	
	var dragStartBlocks = 2;
	var blockIndex = 0;
	var dragState = 0;
	var dragStartX;
	contentbox.addEventListener("pointerdown", (event) => {
		dragState = 1;
		dragStartX = event.clientX;
		dragStartBlocks = blocks;
	});
	
	contentbox.addEventListener("pointermove", (event) => {
		if (dragState != 0) {
			let currentX = event.clientX;
			let newblocks = dragStartBlocks - Math.floor( (currentX-dragStartX+50)/100 )
			let maxblocks = Math.floor(window.innerWidth/50)
			if (newblocks>50) { newblocks = 50 }; // Cap block width to 20
			if (newblocks<minblocks) { newblocks = minblocks };
			if (newblocks != blocks ) {
				blocks = newblocks;
				reblockGrid();
			}
		}
	});
	
	contentbox.addEventListener("pointerup", (event) => {
		dragState = 0; // End dragging event
	});
	
	var current_blocks = 2;
	contentbox.addEventListener("scroll", (event) => {
		if (blocks != current_blocks) {
			current_blocks = blocks;
			setTimeout(reblockGrid(),1);
		}
	})
	
	var randlist = [];
	
	function shuffle() {
		randlist = [];
		for (let i = 0; i < valid_images.length; i++) { randlist.push(i); } // Make default randlist
		for (let i = randlist.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[randlist[i], randlist[j]] = [randlist[j], randlist[i]];
		}
	}
	
	shuffle();
	
	function score(action) {
		let src = document.getElementById("focusimg").src;
		let name = focus_name;
		let graf = graf_data.get(name);
		let num = graf.i;
		if ( action=='like' ) {
			if ( cookie.likes.includes(name) ) { // Unlike this image
				cookie.likes.splice(cookie.likes.indexOf(name), 1);
				setCookie('likes',cookie.likes.join(',') );
				document.getElementById("like").classList.remove("liked");
				score_counts[num][0] = score_counts[num][0]-1;
				like_button.innerHTML = 'Like ('+String(score_counts[num][0])+')';
				sendscore("?u="+cookie.uuid+"&t=m&n="+String(num+1));
			}
			else { // Like this image
				cookie.likes.push(name);
				setCookie('likes',cookie.likes.join(',') );
				document.getElementById("like").classList.add("liked");
				score_counts[num][0] = score_counts[num][0]+1;
				like_button.innerHTML = 'Like ('+String(score_counts[num][0])+')';
				sendscore("?u="+cookie.uuid+"&t=l&n="+String(num+1));
			}
		}
		else if ( action=='favorite' ) {
			if ( cookie.favorites.includes(name) ) {
				cookie.favorites.splice(cookie.favorites.indexOf(name), 1);
				setCookie('favorites',cookie.favorites.join(',') );
				document.getElementById("favorite").classList.remove("favorited"); // Make ungreen
				if (graf.tags.includes('favorites')) { graf.tags.splice(graf.tags.indexOf('favorites'),1); } // Remove favorite tag
				score_counts[num][1] = score_counts[num][1]-1;
				favorite_button.innerHTML = 'Favorite ('+String(score_counts[num][1])+')';
				sendscore("?u="+cookie.uuid+"&t=g&n="+String(num+1));
				setTimeout(() => { updateCounts(); }, "100");
			}
			else {
				cookie.favorites.push(name);
				setCookie('favorites',cookie.favorites.join(',') );
				document.getElementById("favorite").classList.add("favorited"); // Make green
				graf.tags.push('favorites'); // Add favorite tag
				score_counts[num][1] = score_counts[num][1]+1;
				favorite_button.innerHTML = 'Favorite ('+String(score_counts[num][1])+')';
				sendscore("?u="+cookie.uuid+"&t=f&n="+String(num+1));
				setTimeout(() => { updateCounts(); }, "100");
			}
		}
	}
	
	function jumpNum(num) {
		if(num=="") {return}
		
		if (mode=='Images') { image = document.getElementById("img" + String(num) ) }
		else { image = document.getElementById("line" + String(num) ) }
		blocks=minblocks;
		reblockGrid()
		image.scrollIntoView(false);
		//window.scrollBy(0,window.innerHeight/2);
		document.getElementById("tagbox").classList.add("hidden");
		document.getElementById("sunglasses").classList.add("hidden");
		if (search_string!="") { document.getElementById("searchbar").value = search_string + ' (' + String(valid_images.length) + ')'; }
		//else { document.getElementById("searchbar").value = ""; }
		showtags = 0;
		document.getElementById("colorbutton").style.display = "block";
		document.getElementById("backbutton").style.display = "none";
		document.getElementById("colorbutton").classList.remove("fullopacity")
		image.focus();
	}
	
	function jumpTo(event) {
		if (event=='bypass' || event.keyCode==13 || event.keyCode==9) { // Return or Tab key
			let num = document.getElementById("jumpto").value;
			if(num=="") {return}
			else { num=Number(num); }
			if (num<1) { num = 1; }
			else if (num>999) { num = 999; }
			document.getElementById("jumpto").value = num;
			if (!valid_images.includes(String(num))) {
				if ( hearts ) { document.getElementById("jumpto").value=''; return } // Exit if in hearts and not included
				document.getElementById('searchbar').value = " "; updateSearchbar(); // If num not in selection, reset to include all
			}
			if (mode=='Images') { image = document.getElementById("img" + String(num) ) }
			else { image = document.getElementById("line" + String(num) ) }
			blocks=minblocks;
			reblockGrid()
			image.scrollIntoView(false);
			//window.scrollBy(0,window.innerHeight/2);
			document.getElementById("tagbox").classList.add("hidden");
			document.getElementById("sunglasses").classList.add("hidden");
			if (search_string!="") { document.getElementById("searchbar").value = search_string + ' (' + String(valid_images.length) + ')'; }
			//else { document.getElementById("searchbar").value = ""; }
			showtags = 0;
			document.getElementById("colorbutton").style.display = "block";
			document.getElementById("backbutton").style.display = "none";
			document.getElementById("colorbutton").classList.remove("fullopacity")
			image.focus();
			document.getElementById("jumpto").value='';
		}
	}
	
	function switchMode() {
		if (showtags==1) { hideTags(); return }
		
		if (mode=='Images') {
			let images = document.getElementsByClassName("image");
			for(let i=0; i<images.length; i++) { images[i].style.display="none"; }
			
			document.getElementById("colorbutton").classList.add("graybutton");
			
			let lines = document.getElementsByClassName("line");
			for(let i=0; i<lines.length; i++) { lines[i].style.display="block"; }
			
			document.body.style.backgroundColor = "grey";
			document.getElementById("focusback").style.backgroundColor = "grey";
			mode = 'Lines'
			if ( hearts ) {
				hearts = 0;
				updateCounts()
				redrawImages()
			}
		}
		else if (mode=='Lines') {
			let images = document.getElementsByClassName("image");
			for(let i=0; i<images.length; i++) { images[i].style.display="block"; }
			
			document.getElementById("colorbutton").classList.remove("graybutton");
			
			let lines = document.getElementsByClassName("line");
			for(let i=0; i<lines.length; i++) { lines[i].style.display="none"; }
			
			document.body.style.backgroundColor = "black";
			document.getElementById("focusback").style.backgroundColor = "black";
			mode = 'Images'
			
		}
	}
	
	function hideFocus() {
		document.getElementById("focusbox").classList.add("hidden");
		if (document.getElementById("focusvid").src != '') {
			document.getElementById("focusimg").style.display = 'block';
			document.getElementById("focusvid").src = '';
			document.getElementById("focusvid").style.display = 'none';
		}
	}
	
	var stay_hearts = 0; // Prevents toggling back to normal after clicking hearts button - reset on reloading focus_box
	var focus_name = 0;
	function focusImage(id,src) {
		document.getElementById("focusimg").src = ""; // Clear last focus image before loading new one
		stay_hearts = 0;
		focus_name = id.replace('img',"");
		graf = graf_data.get(focus_name);
		sendscore("?u="+cookie.uuid+"&t=v&n="+String(graf.i+1));
		focus_img = document.getElementById("focusimg");
		if (mode=='Lines' && graf.noL) { focus_img.classList.add("gray"); }
		else { focus_img.classList.remove("gray"); }
		if ( focus_name==226 ) { focus_img.src = 'Images/226.gif';}
		else if ( focus_name==999 ) { focus_img.src = 'Images/999.gif';}
		else { focus_img.src = src.replace('_thumb','');}
		//document.getElementById("focusbox").requestFullscreen();
		
		like_button = document.getElementById('like');
		favorite_button = document.getElementById('favorite');
		
		if (score_counts) {
			//console.log(score_counts);
			like_button.innerHTML = 'Like ('+String(score_counts[graf.i][0])+')';
			favorite_button.innerHTML = 'Favorite ('+String(score_counts[graf.i][1])+')';
		}
		
		if ( cookie.likes.includes(String(focus_name)) ) { like_button.classList.add('liked'); }
		else { like_button.classList.remove('liked'); }
		if ( cookie.favorites.includes(String(focus_name)) ) { favorite_button.classList.add('favorited'); }
		else { favorite_button.classList.remove('favorited'); }
		
		let img_tags = graf.tags
		const imgtaglist = document.getElementById("imgtaglist");
		while (imgtaglist.lastElementChild) { // Clear imgtaglist
			imgtaglist.removeChild(imgtaglist.lastElementChild);
		}
		for (let i=0; i < img_tags.length; i++) {
			let tag = img_tags[i];
			let imgtag_bubble = mkElement("h3", "imgtag_"+tag, "tag_bubble nodrag");
			imgtag_bubble.innerHTML = tag;
			imgtag_bubble.onclick = function() { document.getElementById('searchbar').value=imgtag_bubble.innerHTML+' '; updateSearchbar(); hideFocus(); };
			imgtaglist.appendChild(imgtag_bubble);
		}
		
		if (focus_name=='367'||focus_name=='494') {
			document.getElementById("imgtag_@dobbele").remove();
			let dobbele_bubble = mkElement("h3", "suggest", "tag_bubble nodrag");
			dobbele_bubble.innerHTML = "+dobbele";
			dobbele_bubble.style.color = "#e66423";
			dobbele_bubble.style.backgroundColor = "#83cb39";
			document.getElementById('focusvid').src = 'Images/'+focus_name+'.mp4';
			dobbele_bubble.onclick = function() {
				document.getElementById('focusimg').style.display='none';
				document.getElementById('focusvid').style.display='block';
				document.getElementById('focusvid').play();
			};
			imgtaglist.appendChild(dobbele_bubble);
		}
		
		let suggest_bubble = mkElement("h3", "suggest", "tag_bubble nodrag");
		suggest_bubble.innerHTML = "+Suggest Tag";
		suggest_bubble.onclick = function() { window.open('suggest.html?num='+String(focus_name)); };
		imgtaglist.appendChild(suggest_bubble);
		
		if (graf.reddit) {
			document.getElementById("redditdiv").classList.remove("hidden");
			document.getElementById("reddit").onclick = function() { window.open("https://www.reddit.com/"+graf.reddit); sendsearch( "?u="+cookie.uuid+"&t=r&n="+String(focus_name) ); }
		}
		else { document.getElementById("redditdiv").classList.add("hidden"); }
		
		if (!graf.tags.includes('plotlo')) {
			document.getElementById("discorddiv").classList.remove("hidden");
			document.getElementById("discord").onclick= function() { window.open("https://discord.com/invite/TsBGYz4VTg"); sendsearch( "?u="+cookie.uuid+"&t=d&n="+String(focus_name) ); }
		}
		else { document.getElementById("discorddiv").classList.add("hidden"); }
		
		if (graf.twitter) {
			document.getElementById("twitterdiv").classList.remove("hidden");
			if ( graf.twitter_alt==1 ) { twitter_account = "https://twitter.com/SrGrafo_Art/status/"; }
			else if ( graf.twitter_alt==2 ) { twitter_account = "https://twitter.com/HarxMLeth/status/"; }
			else { twitter_account = "https://twitter.com/ChloeLouvre/status/"; }
			document.getElementById("twitter").onclick = function() { window.open(twitter_account+graf.twitter); sendsearch( "?u="+cookie.uuid+"&t=x&n="+String(focus_name) ); }
		}
		else { document.getElementById("twitterdiv").classList.add("hidden"); }
		
		if ( graf.hoodie ) {
			document.getElementById('hoodiediv').style.display = 'block';
			document.getElementById('hoodiediv').onclick = function() { window.open(hoodie_links[graf.hoodie]); sendsearch( "?u="+cookie.uuid+"&t=h&n="+String(focus_name) ); }
		}
		else if ( img_tags.includes('hoodie') ) {
			document.getElementById('hoodiediv').style.display = 'block';
			document.getElementById('hoodiediv').onclick = function() { window.open("https://srgrafo.myshopify.com/"); sendsearch( "?u="+cookie.uuid+"&t=h&n="+String(focus_name) ); }
		}
		else { document.getElementById('hoodiediv').style.display = 'none'; }
		
		if (graf.gumroad) {
			document.getElementById("heartsdiv").classList.remove("hidden");
			gumroad_path = "https://srgrafo.gumroad.com/l/" + graf.gumroad + "?layout=profile";
			
			if (graf.heart) {
				heartspath = 'Hearts/' + id.replace('img',"") + ".webp";
				//if (focus_name=='494') { heartspath = 'Hearts/494.gif'; }
				document.getElementById("hearts").onclick = function() {
					window.open(gumroad_path);
					document.getElementById("focusimg").src = heartspath;
					stay_hearts = 1; // Keep hearts on the focus_img after clicking through to gumroad instead of flipping back to normal after mouse leaves heart button
					sendsearch( "?u="+cookie.uuid+"&t=g&n="+String(focus_name) );
				}
				document.getElementById("hearts").onmouseenter = function() { if (stay_hearts==0) {document.getElementById("focusimg").src = heartspath; } }
				document.getElementById("hearts").onmouseleave = function() { if (stay_hearts==0) { document.getElementById("focusimg").src = mode + '/' + id.replace('img',"") + ".webp"; } }
				//if (focus_name=='494') { document.getElementById("hearts").onmouseleave = function() { if (stay_hearts==0) { document.getElementById("focusimg").src = 'Images/' + id.replace('img',"") + ".webp"; } } }

			}
			else {
				document.getElementById("hearts").onclick = function() { window.open(gumroad_path); }
				document.getElementById("hearts").onmouseenter = ""
				document.getElementById("hearts").onmouseleave = ""
			}
		}
		else { document.getElementById("heartsdiv").classList.add("hidden"); }
		
		if (focus_name=="596" || focus_name=="231") {
			document.getElementById("heartsdiv").classList.remove("hidden"); 
			document.getElementById("hearts").onclick = function() {
				if (mode=='Lines') { switchMode(); }
				hearts = 1;
				document.getElementById('searchbar').value = "";
				updateCounts()
				updateSearchbar()
				document.body.scrollTop = document.documentElement.scrollTop = 0; // Jump to top
				blocks = Math.floor((width-100)/100);
				if (blocks < 1) { blocks = 1; }
				if (blocks > 5) { blocks = 5; }
				redrawImages();
				hideFocus();
				sendsearch( "?u="+cookie.uuid+"&t=n&n="+String(focus_name) );
			}
			document.getElementById("hearts").onmouseenter = ""
			document.getElementById("hearts").onmouseleave = ""
		}
		
		document.getElementById("focusbox").classList.remove("hidden");
	}
	
	function reblockGrid() {
		let images
		if (mode=='Images') { images = document.getElementsByClassName("image"); }
		else { images = document.getElementsByClassName("line"); }
		if (images.length==0) {return}
		let closestimage
		let mindist = 10000;
		for (let  i=0; i<images.length; i++) {
			bounds = images[i].getBoundingClientRect()
			dist = Math.abs(window.innerHeight/2 +100 -bounds.bottom)
			if (dist<mindist) {
				mindist=dist;
				closestimage=images[i];
			}
		}
		
		document.querySelectorAll('.grid-container').forEach((group) => {
			group.style["grid-template-columns"] = 'repeat('+String(blocks)+', minmax(0, 1fr))';
		});
		
		bounds = closestimage.getBoundingClientRect()
		diff = window.innerHeight/2 +100 - bounds.bottom; // Bring element back to prev center position
		if (centerjump) { window.scrollBy(0,-diff); } // centerjump is true after the first pass
	}
	
	function mkElement(type, id, clas) {
		let newel = document.createElement(type);
		if (id) {
			newel.setAttribute("id", id);
		}
		if (clas) {
			newel.setAttribute("class", clas);
		}
		return newel;
	}
	
	function redrawImages() {
		const contentbox = document.getElementById("contentbox");
		while (contentbox.lastElementChild) { // Clear contentbox
			contentbox.removeChild(contentbox.lastElementChild);
		}
		let sort = document.getElementById("sort").value;
		for (let i=11; i > 0; i--) {
			if (sort=='old'||sort=='rand') { j = 12-i; } // Reverse order for old first, for rand start with 1
			else { j=i; }
			let newheader = mkElement("h2", "header"+String(j), "grouptitle nodrag");
			newheader.innerHTML = 'Season '+String(j)
			document.getElementById("contentbox").appendChild(newheader);
			
			if (sort!='rand') {
				newheader.onclick = function() {
					groupid= newheader.id.replace('header','group');
					let group = document.getElementById(groupid);
					if ( group.style.display == 'none' ) { group.style.display = 'grid'; newheader.style.textDecoration = ''; }
					else { group.style.display = 'none'; newheader.style.textDecoration = 'underline'; }
				}
			}
			
			let newgroup =  mkElement("div", "group"+String(j), "grid-container nodrag");
			document.getElementById("contentbox").appendChild(newgroup);
			if (sort=='rand') { newheader.innerHTML = 'Random Order'; break } // Only create one header if random
		}
		len = valid_images.length;
		if (sort=='rand') { shuffle(); }
		for (let i=len-1; i > -1; i--) {
			if (sort=='new') { j=i; }
			else if (sort=='old') { j=len-i-1; } // Offset by -1 to make this work, no I don't know why...
			else if (sort=='rand') { j=randlist[i]; } // Scramble according to the same random list generated on start or selection
			name = valid_images[j];
			graf = graf_data.get(name);
			
			// NOTE - need to add some code here to specify group for non-numeric named ids (Though because in JS '999.1'-1 = 998.1 decimal names should be fine... cursed)
			// Me later, yeah I just decided to go with the cursed option and use only numeric names
			if (sort=='rand') { groupid = "group1"; }
			else { groupid = "group"+String(Math.floor((name-1)/100)+1); }
			
			let newimg = mkElement("img", "img"+name, "image nodrag"); // Generate img element for Image/Hearts
			if ( hearts ) {
				if ( graf.nnn ) { newimg.src = 'Images_thumb/'+name+'.webp'; } // Special case when Image works for Hearts too
				else { newimg.src = 'Hearts/'+name+'.webp'; }
			}
			else { newimg.src = 'Images_thumb/'+name+'.webp'; }
			newimg.onclick = function() { focusImage(newimg.id,newimg.src); }
			newimg.loading = 'lazy'
			if (mode=='Lines') { newimg.style.display = "none"; }
			document.getElementById(groupid).appendChild(newimg);
			
			
			let newline = mkElement("img", "line"+String(j), "line nodrag");
			if ( !(graf.noL) ) { // Downselect for only images with lines
				newline.src = 'Lines_thumb/'+name+'.webp';
			}
			else {
				newline.src = 'Images_thumb/'+name+'.webp';
				newline.classList.add("gray"); // Show imgs with no lines but grayscale
			}
			newline.onclick = function() { focusImage(newimg.id,newline.src); };
			newline.loading = 'lazy'
			if (mode!='Lines') { newline.style.display = "none"; }
			document.getElementById(groupid).appendChild(newline);
			
		}
		reblockGrid()
	}
	
	var showtags = 0;
	function toggleTags() {
		if (showtags==0) {
			document.getElementById("tagbox").classList.remove("hidden");
			document.getElementById("sunglasses").classList.remove("hidden");
			showtags = 1;
		}
		else {
			document.getElementById("tagbox").classList.add("hidden");
			document.getElementById("sunglasses").classList.add("hidden");
			showtags = 0;
		}
	}
	
	function showTags() {
		if (showtags==1 && document.getElementById('searchbar').value=='') { hideTags(); return }
		document.getElementById("tagbox").classList.remove("hidden");
		document.getElementById("sunglasses").classList.remove("hidden");
		document.getElementById("searchbar").value = search_string + ' ';
		document.getElementById("colorbutton").style.display = "none";
		document.getElementById("backbutton").style.display = "block";
		document.getElementById("colorbutton").classList.add("fullopacity");
		updateSearchbar()
		showtags = 1;
	}
	
	var prev_search_string = '';
	function hideTags() {
		document.getElementById("tagbox").classList.add("hidden");
		document.getElementById("sunglasses").classList.add("hidden");
		if (search_string!="") { document.getElementById("searchbar").value = search_string + ' (' + String(valid_images.length) + ')'; }
		//else { document.getElementById("searchbar").value = ""; }
		showtags = 0;
		document.getElementById("colorbutton").style.display = "block";
		document.getElementById("backbutton").style.display = "none";
		document.getElementById("colorbutton").classList.remove("fullopacity")
		if (search_string != '' && search_string != prev_search_string) {
			sendsearch("?u="+cookie.uuid+"&t=s&o="+document.getElementById("sort").value+"&s="+search_string.replaceAll('+','--'));
			prev_search_string = search_string;
		}
	}
	
	function modifySelection(tag,change) { // change to selection bar can be "add" "sub" "rem" "set"

		selection = document.getElementById("searchbar");
		if (change=="set") {
			selection.innerHTML = tag;
		}
		else {
			if ( tag.includes(" ") ) { tag = tag.substr(0,tag.indexOf(" ")); } // Get rid of num after the space
			selection_list = selection.innerHTML.split(" ");
			selection_list = selection_list.filter(tag => !tag.includes(')'));
			selection.innerHTML = selection_list.join(" ");
		}
		if ( change=="add" ) {
			selection.innerHTML = selection.innerHTML + " " + tag;
		}
		else if ( change=="rem" ) {
			selection.innerHTML = selection.innerHTML.replace(tag,"")
			let list_tags = selection.innerHTML.split(" ");
			list_tags = list_tags.filter(function(el) { return el; }); // Get rid of empty spaces
			selection.innerHTML = list_tags.join(" ");
			
		}
		else if ( change=='sub' ) {
			let index = selection.innerHTML.indexOf(tag);
			selection.innerHTML = selection.innerHTML.slice(0,index) + "-" + selection.innerHTML.slice(index);
		}
		if ( selection.innerHTML.includes("Search... ") ) { selection.innerHTML=selection.innerHTML.replace("Search... ",""); }
		else if ( selection.innerHTML=="" || selection.innerHTML==" " ) { selection.innerHTML="Search..."; }
		downselect()
		redrawImages() 
	}
	
	goto_num = urlParams.get('num'); // Parameter to jump to image num
	if (goto_num) {
		document.getElementById("jumpto").value = Number(goto_num);
		setTimeout(() => { jumpTo('bypass'); focusImage('img'+goto_num,'Images_thumb/'+goto_num+'.webp') }, "200");
	}
	
	var centerjump = 0;
	reblockGrid()
	centerjump = 1;
	
</script>

</html>
