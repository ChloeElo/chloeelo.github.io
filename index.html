<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<head>
<style>

@font-face {
    font-family: WildWords;
    src: url(wildwords.ttf);
}

body {
	position:absolute;
	background-color: black;
	justify-content: center;
	margin: 0;
	overflow:auto;
	-ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
    text-align: center;
	touch-action: pan-y;
}

body::-webkit-scrollbar { 
    display: none;  /* Safari and Chrome */
}

#contentbox {
	position: absolute;
	width: 100vw;
	padding-top: 75px;
}

#searchbox {
	position: fixed;
	justify-content: center;
    align-items: center;
	text-align: center;
	margin: 0,auto;
	height: 75px;
	width: 100vw;
	display:flex;
}

#searchbar {
	justify-content: center;
    align-items: center;
	text-align: center;
	margin: auto;
	background-color: #4a4c51;
	width:90%;
	height:fit-content;
	min-height:24px;
	color: #C0C0C0;
	font-size: 16pt;
	font-family: sans-serif;
	border-radius: 20px;
	opacity: 0.7;
	padding-top:5px;
	padding-bottom:5px;
	padding-left: 10px;
	padding-right: 10px;
}

#searchbar:hover {
	opacity:1;
	transition:200ms;
}

.grouptitle {
	color: white;
	font-family: sans-serif;
	color: #4a4c51;
	font-size: 24pt;
	margin: 0;
}

.grid-container {
	display: grid;
	grid-gap: 5px;
	width: 100vw;
	justify-content: center;
    align-items: center;
    overflow: hidden;
	padding-top: 5px;
	padding-bottom: 5px;
}

.image {
	width: 100%;
	object-fit: cover;
	aspect-ratio: 1;
	border-radius: 10px;
}

.image_lines {
	object-fit: contain;
	outline: black solid 1px;
}

.nodrag {
	user-drag: none;
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
}

.image:hover {
	outline: white solid 4px;
	transition:100ms;
}

.hidden {
	transition: opacity 0.75s ease-out !important;
    opacity: 0 !important;
    height: 0;
    overflow: hidden !important;
	pointer-events: none;
}

#tagbox {
	position:fixed;
	width:100vw;
	height:100vh;
	overflow:hidden;
	transition: opacity 0.5s ease-in;
}

#sunglasses {
	position:fixed;
	background-color: black;
	opacity:0.8;
	transition: opacity 0.5s ease-in;
	width:100vw;
	height:100vh;
}

#taglist {
	width:100%;
	height:fit-content;
	max-height:calc(100vh - 90px);
	display: inline-flex;
	flex-flow: wrap;
	justify-content: center;
	overflow-y:auto;
}

#searchoptions {
	width:100%;
	height:30px;
	margin-top: 65px;
}

#jumpto {
	width:125px;
	height:20px;
	border-radius:10px;
	text-align: center;
}

#imgtaglist {
	width:100%;
	height:fit-content;
	display: inline-flex;
	flex-flow: wrap;
	justify-content: center;
	overflow-y:auto;
}

.tag_bubble {
	background-color: #808080;
	color: white;
	font-family: sans-serif;
	font-size: 14pt;
	padding-left:10px;
	padding-right:10px;
	padding-top:5px;
	padding-bottom:5px;
	margin-left:5px;
	margin-right:5px;
	margin-top:5px;
	margin-bottom:5px;
	border-radius: 10px;
	height:fit-content;
	opacity:0.9;
}

#focusbox {
	background-color: black;
	position:fixed;
	height:100vh;
	width:100vw;
	opacity:1;
	transition: opacity 0.5s ease-in;
}

#colorbutton {
	position:fixed;
	top:0px;
	left:0px;
	width: 50px;
	height: 50px;
	background: conic-gradient(
	from 180deg,
	violet,
	DodgerBlue,
	yellowgreen,
	yellow,
	orange,
	red,
	violet
	);
	outline: black solid 1.5px;
	margin: 12px;
	border-radius: 50%;
	opacity:0.5;
}

#colorbutton:hover {
	opacity:1;
	transition:100ms;
}

</style>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<!-- <script src="./index.js" defer></script> -->
<title>Search</title>

</head>

<body>
	<div id="contentbox"></div>
	<div id='sunglasses' class="hidden"> </div>
	<div id='tagbox' class="hidden">
		<div id='searchoptions'> <input type="number" id="jumpto" min="1" max="998" placeholder="Jump to number..." onkeypress="jumpTo(event)"> </div>
		<div id='taglist' class="flex-container"></div>
		<div id='taglist_below' onclick="showTags()" style="width:100%;height:100vh;"></div>
	</div>
	<div id='searchbox'>
		<h1 id="searchbar" class="nodrag" onclick="showTags()">Search...</h1>
	</div>
	<div id="colorbutton" onclick="switchMode()"></div>
	<div id="focusbox" class="hidden">
		<img id='focusimg' onclick="hideFocus()" style="object-fit:contain;max-height:80vh;width:100vw;image-rendering:pixelated;" src="Images/1.webp">
		<div id='imgtaglist' class="flex-container"></div>
		<div id='imgtaglist_below' onclick="hideFocus()" style="width:100%;height:100vh;"></div>
	</div>
	
	

</body>

<script src="data.js"></script>

<script>
	
	let width = window.innerWidth;
	var blocks = Math.floor((width-100)/100); // Set default block width based on screen res
	if (blocks < 1) { blocks = 1; }
	if (blocks > 5) { blocks = 5; } // Cap block width to 5 on load to avoid lagginess when the browser has to load hundreds of images at once

	stylesheet = document.styleSheets[0]
	stylesheet.insertRule(".grid-container { grid-template-columns: repeat("+String(blocks)+", minmax(0, 1fr));}", 0);
	
	grid_xscale = [0,0.15,0.3,0.45,0.6,0.75,0.85,0.95,1.1]; // 1.1 is there for initial block scaling reference - me much later, WTF does that mean?
	
	var minblocks = Math.ceil(window.innerWidth/800); // Don't force upscale of images past 800px - see below
	var mode = 'Images';
	
	window.addEventListener("resize", (event) => { // If the browser expands, expand minblocks - TODO make sure minblocks and maxblocks don't nonintersect
		console.log('resize');
		minblocks = Math.ceil(window.innerWidth/800); // N+1 minblock per 800px of width so images are never upscaled, only downscaled on the grid
		if (blocks < minblocks) {
			blocks = minblocks;
			reblockGrid()
		}
	});
	
	function jumpTo(event) {
		if (event=='bypass' || event.keyCode==13) { // Return key
			let num = document.getElementById("jumpto").value;
			if(num=="") {return}
			else { num=Number(num); }
			if (num<1) { num = 1; }
			else if (num>998) { num = 998; }
			document.getElementById("jumpto").value = num;
			if (!valid_images.includes(num)) { modifySelection("","set") } // If num not in selection, reset to include all
			let image = document.getElementById("img" + String(num) )
			blocks=minblocks;
			reblockGrid()
			image.scrollIntoView(false);
			//window.scrollBy(0,window.innerHeight/2);
			document.getElementById("tagbox").classList.add("hidden");
			document.getElementById("sunglasses").classList.add("hidden");
			showtags = 0;
			image.focus();
		}
	}
	
	function switchMode() {
		if (mode=='Images') {
			let images = document.getElementsByClassName("image");
			for(let i=0; i < images.length; i++)
			{
				images[i].src = images[i].src.replace('Images','Lines');
				images[i].classList.add("image_lines");
			}
			document.body.style.backgroundColor = "grey";
			document.getElementById("focusimg").style.backgroundColor = "grey";
			mode = 'Lines'
		}
		else if (mode=='Lines') {
			let images = document.getElementsByClassName("image");
			for(let i=0; i < images.length; i++)
			{
				images[i].src = images[i].src.replace('Lines','Images');
				images[i].classList.remove("image_lines");
			}
			document.body.style.backgroundColor = "black";
			document.getElementById("focusimg").style.backgroundColor = "black";
			mode = 'Images'
		}
	}
	
	function hideFocus() { document.getElementById("focusbox").classList.add("hidden"); }
	
	var focus_num = 0;
	function focusImage(id) {
		focus_num = Number(id.replace('img',""))-1;
		document.getElementById("focusimg").src = mode + '/' + id.replace('img',"") + ".webp";
		let img_tags = image_tags[focus_num]
		const imgtaglist = document.getElementById("imgtaglist");
		while (imgtaglist.lastElementChild) { // Clear imgtaglist
			imgtaglist.removeChild(imgtaglist.lastElementChild);
		}
		for (let i=0; i < img_tags.length; i++) {
			let tag = img_tags[i];
			let imgtag_bubble = mkElement("h3", "imgtag_"+tag, "tag_bubble nodrag");
			imgtag_bubble.innerHTML = tag;
			imgtag_bubble.onclick = function() { modifySelection(imgtag_bubble.innerHTML,'set');  hideFocus(); };
			imgtaglist.appendChild(imgtag_bubble);
		}
		document.getElementById("focusbox").classList.remove("hidden");
	}

	var dragStartBlocks = 2;
	var dragState = 0;
	var dragStartX;
	contentbox.addEventListener("pointerdown", (event) => {
		dragState = 1;
		dragStartX = event.clientX;
		dragStartBlocks = blocks;
	});
	
	contentbox.addEventListener("pointermove", (event) => {
		if (dragState != 0) {
			let currentX = event.clientX;
			let newblocks = dragStartBlocks - Math.floor( (currentX-dragStartX+50)/100 )
			if (newblocks>20) { newblocks = 20 }; // Cap block width to 20
			if (newblocks<minblocks) { newblocks = minblocks };
			if (newblocks != blocks ) {
				blocks = newblocks;
				reblockGrid();
			}
		}
	});
	
	contentbox.addEventListener("pointerup", (event) => {
		dragState = 0; // End dragging event
	});
	
	var current_blocks = 2;
	contentbox.addEventListener("scroll", (event) => {
		if (blocks != current_blocks) {
			current_blocks = blocks;
			setTimeout(reblockGrid(),1);
		}
	})
	
	function reblockGrid() {
		document.querySelectorAll('.grid-container').forEach((group) => {
			group.style["grid-template-columns"] = 'repeat('+String(blocks)+', minmax(0, 1fr))';
		});
	}
	
	function mkElement(type, id, clas) {
		let newel = document.createElement(type);
		if (id) {
			newel.setAttribute("id", id);
		}
		if (clas) {
			newel.setAttribute("class", clas);
		}
		return newel;
	}
	
	var valid_images = []
	
	urlParams = new URLSearchParams(window.location.search);
	paramselection = urlParams.get('search'); // Parameter for default search
	if (paramselection) { modifySelection(paramselection.replace("%20"," "),'set'); }
	else { downselect(); redrawImages(); }
	
	goto_num = urlParams.get('num'); // Parameter to jump to image num
	if (goto_num) {
		document.getElementById("jumpto").value = Number(goto_num);
		setTimeout(() => { jumpTo('bypass'); }, "200");
	}
	
	function redrawImages() {
		const contentbox = document.getElementById("contentbox");
		while (contentbox.lastElementChild) { // Clear contentbox
			contentbox.removeChild(contentbox.lastElementChild);
		}
		for (let i=10; i > 0; i--) {
			let newheader = mkElement("h2", "header"+String(i), "grouptitle nodrag");
			newheader.innerHTML = 'Season '+String(i)
			document.getElementById("contentbox").appendChild(newheader);
			
			let newgroup =  mkElement("div", "group"+String(i), "grid-container nodrag");
			document.getElementById("contentbox").appendChild(newgroup);
		}
		for (let i=998; i > 0; i--) {
			if ( valid_images.includes(i) ) {
				let newimg;
				if (mode=='Images') { newimg = mkElement("img", "img"+String(i), "image nodrag"); }
				else if (mode=='Lines') { newimg = mkElement("img", "img"+String(i), "image image_lines nodrag"); }
				newimg.src = mode+'/'+String(i)+'.webp';
				newimg.onclick = function() { focusImage(newimg.id); };
				newimg.loading = 'lazy'
				document.getElementById("group"+String(Math.floor((i-1)/100)+1)).appendChild(newimg);
			}
		}
	}
	
	var showtags = 0;
	function showTags() {
		if (showtags==0) {
			document.getElementById("tagbox").classList.remove("hidden");
			document.getElementById("sunglasses").classList.remove("hidden");
			showtags = 1;
		}
		else {
			document.getElementById("tagbox").classList.add("hidden");
			document.getElementById("sunglasses").classList.add("hidden");
			showtags = 0;
		}
	}
	
	function modifySelection(tag,change) { // change to selection bar can be "add" "sub" "rem" "set"

		selection = document.getElementById("searchbar");
		if (change=="set") {
			selection.innerHTML = tag;
		}
		else {
			if ( tag.includes(" ") ) { tag = tag.substr(0,tag.indexOf(" ")); } // Get rid of num after the space
			selection_list = selection.innerHTML.split(" ");
			selection_list = selection_list.filter(tag => !tag.includes(')'));
			selection.innerHTML = selection_list.join(" ");
		}
		if ( change=="add" ) {
			selection.innerHTML = selection.innerHTML + " " + tag;
		}
		else if ( change=="rem" ) {
			selection.innerHTML = selection.innerHTML.replace(tag,"")
			let list_tags = selection.innerHTML.split(" ");
			list_tags = list_tags.filter(function(el) { return el; }); // Get rid of empty spaces
			selection.innerHTML = list_tags.join(" ");
			
		}
		else if ( change=='sub' ) {
			let index = selection.innerHTML.indexOf(tag);
			selection.innerHTML = selection.innerHTML.slice(0,index) + "-" + selection.innerHTML.slice(index);
		}
		if ( selection.innerHTML.includes("Search... ") ) { selection.innerHTML=selection.innerHTML.replace("Search... ",""); }
		else if ( selection.innerHTML=="" || selection.innerHTML==" " ) { selection.innerHTML="Search..."; }
		downselect()
		redrawImages() 
	}
	
	function contains(these,inthis){ if (these.length==0) { return 1 } else { return these.every(i => inthis.includes(i)); } } // Self explanatory
	function excludes(these,inthis){ if (these.length==0) { return 1 } else { return !these.some(i => inthis.includes(i)); } } // Self explanatory
	
	function downselect() { // Regenerate tag selection options based on current search selection
		let selection = document.getElementById("searchbar");
		let include = []
		let exclude = []
		valid_images = []
		
		if ( !["Search...",""].includes(selection.innerHTML) ) {
			let selection_list = selection.innerHTML.split(" ");
			selection_list = selection_list.filter(tag => !tag.includes(')'));
			for (let i=0; i < selection_list.length; i++){
				if (selection_list[i][0]=="-") { exclude.push(selection_list[i].substr(1)) }
				else { include.push(selection_list[i]) }
			}
		}
		
		let counts = {} // Tagcounts are shown next to tag names
		for (let i=0; i < search_tags.length; i++){ counts[search_tags[i]] = 0 } // Reset all to 0 before we start counting
		
		for (let i=0; i < image_tags.length; i++){
			img_tags = image_tags[i]
			if ( contains(include,img_tags) && excludes(exclude,img_tags) ) { // Check that valid images have tags matching searchbar filter
				valid_images.push(i+1);
				for (let i=0; i < img_tags.length; i++){
					//if ( !include.includes(img_tags[i]) && !exclude.includes(img_tags[i]) ) { // Don't actually count the tags in the searchbar tho
						counts[img_tags[i]] += 1;
					//}
				}
			}
		}
		
		selection_list = selection.innerHTML.split(" ");
		selection.innerHTML = selection_list.join(" ") + ' (' + String(valid_images.length) + ')';
		
		const taglist = document.getElementById("taglist");
		while (taglist.lastElementChild) { // Clear taglist
			taglist.removeChild(taglist.lastElementChild);
		}
		
		for (let i=0; i < include.length; i++) { // Green bubbles for included tags
			tag = include[i];
			let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
			tag_bubble.style.backgroundColor = "green";
			tag_bubble.innerHTML = tag;
			tag_bubble.onclick = function() { modifySelection(tag_bubble.innerHTML,'sub'); };
			taglist.appendChild(tag_bubble)
		}
		
		for (let i=0; i < exclude.length; i++) { // Red bubbles for excluded tags
			tag = exclude[i];
			let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
			tag_bubble.style.backgroundColor = "red";
			tag_bubble.innerHTML = tag;
			tag_bubble.onclick = function() { modifySelection('-'+tag_bubble.innerHTML,'rem'); };
			taglist.appendChild(tag_bubble)
		}
		
		for (tag in counts) {
			if (counts[tag]>0 && !include.includes(tag) && !exclude.includes(tag)) { // Grey bubbles for all the remaining tags that can still be applied
				let tag_bubble = mkElement("h3", "tag_"+tag, "tag_bubble nodrag");
				tag_bubble.innerHTML = tag + " (" + String(counts[tag]) + ")";
				tag_bubble.onclick = function() { modifySelection(tag_bubble.innerHTML,'add'); };
				taglist.appendChild(tag_bubble)
			}
		}
	}
	
</script>

</html>
